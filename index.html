<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LoL Champions Tracker</title>
    <style>
      :root {
        --gap: 15px;
        --thumb-size: 84px;
      }
      body {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        margin: 0;
        padding: 20px;
        background: #f6f7fb;
        color: #111;
      }
      header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
      }
      .profile-btn {
        padding: 10px 20px;
        border-radius: 12px;
        border: none;
        background-color: gray;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .profile-btn:hover {
        background-color: #1eac25;
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
      }
      .profile-btn.active {
        background-color: #45a049;
        transform: translateY(0);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .buttons {
        display: flex;
        justify-content: center;
        gap: 46px;
        margin-top: 20px;
      }
      #champion-container {
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(var(--thumb-size), 1fr)
        );
        gap: var(--gap);
        justify-items: center;
        padding: 20px 0;
      }
      .champ {
        width: 100%;
        aspect-ratio: 1/1;
        object-fit: contain;
        border-radius: 8px;
        background: white;
        padding: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: transform 0.2s ease, filter 0.2s ease, opacity 0.2s ease;
      }
      .champ:hover {
        transform: translateY(-4px);
      }
      .champ.won {
        filter: grayscale(100%);
        opacity: 0.55;
      }
      #status {
        margin-top: 12px;
        font-size: 0.9rem;
        color: #444;
        text-align: center;
      }
      footer {
        margin-top: 18px;
        font-size: 0.85rem;
        color: #666;
        text-align: center;
      }
      #controls {
        margin-left: auto;
        display: flex;
        gap: 8px;
      }
      button.small {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>A - Z Challenge</h1>
      <div id="controls">
        <button id="btn-refresh" class="small" title="Neu laden">
          Neu laden
        </button>
        <button id="btn-clear" class="small" title="Alle Markierungen löschen">
          Alle löschen
        </button>
      </div>
    </header>

    <div class="buttons">
      <button class="profile-btn" data-player="laura">Laura</button>
      <button class="profile-btn" data-player="steven">Steven</button>
      <button class="profile-btn" data-player="dennis">Dennis</button>
    </div>

    <main>
      <div id="champion-container"></div>
      <div id="status">Lade Champions …</div>
    </main>

    <footer>
      Speicherung:
      <strong id="storage-mode">Firebase (noch nicht verbunden)</strong>
    </footer>

    <script type="module">
      // ================= CONFIG =================
      const firebaseConfig = {
        apiKey: "AIzaSyAbK1Q1EJZW6ThL9ZxrVy5snjpJUgbUtok",
        authDomain: "championselect-959ee.firebaseapp.com",
        projectId: "championselect-959ee",
        storageBucket: "championselect-959ee.appspot.com",
        messagingSenderId: "791053032351",
        appId: "1:791053032351:web:52a09f547c1ec09a4abbaa",
      };
      const useFirebase = true;
      // ==========================================

      let champions = [];
      let latestVersion = null;
      let currentPlayer = "laura";
      let wonSet = new Set();
      let db,
        auth,
        unsubscribeSnapshot = null;
      let debounceSaveTimer = null;

      const container = document.getElementById("champion-container");
      const statusEl = document.getElementById("status");

      // ===== Firebase initialisieren =====
      if (useFirebase) {
        try {
          const [
            { initializeApp },
            { getFirestore, doc, getDoc, setDoc, onSnapshot },
            { getAuth, signInAnonymously, onAuthStateChanged },
          ] = await Promise.all([
            import("https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"),
            import(
              "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
            ),
            import(
              "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"
            ),
          ]);
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          signInAnonymously(auth).catch(console.warn);
          document.getElementById("storage-mode").textContent =
            "Firebase";
        } catch (err) {
          console.error("Firebase Fehler", err);
          document.getElementById("storage-mode").textContent =
            "Fehler Firebase – fallback localStorage";
        }
      } else {
        document.getElementById("storage-mode").textContent =
          "localStorage (kein Firebase)";
      }

      // ===== Status helper =====
      function setStatus(msg) {
        statusEl.textContent = msg || "";
      }

      // ===== Profile Buttons =====
      document.querySelectorAll(".profile-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".profile-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentPlayer = btn.dataset.player;
          loadProfile(currentPlayer);
        });
      });
      document
        .querySelector('.profile-btn[data-player="laura"]')
        .classList.add("active");

      document
        .getElementById("btn-refresh")
        .addEventListener("click", () => loadAllChamps());
      document.getElementById("btn-clear").addEventListener("click", () => {
        if (!confirm("Alle Markierungen für " + currentPlayer + " löschen?"))
          return;
        wonSet.clear();
        renderChampGrid();
        saveProfile();
      });

      // ===== Load Champions =====
      async function loadAllChamps() {
        setStatus("Lade Champions …");
        try {
          const vres = await fetch(
            "https://ddragon.leagueoflegends.com/api/versions.json"
          );
          const versions = await vres.json();
          latestVersion = versions[0];

          const cres = await fetch(
            `https://ddragon.leagueoflegends.com/cdn/${latestVersion}/data/en_US/champion.json`
          );
          const data = await cres.json();

          champions = Object.keys(data.data).sort((a, b) => {
            const A = data.data[a].name || a;
            const B = data.data[b].name || b;
            return A.localeCompare(B);
          });

          renderChampGrid();
          setStatus("Champions geladen: " + champions.length);
        } catch (e) {
          console.error(e);
          setStatus("Fehler beim Laden der Champions.");
        }
      }

      // ===== Render Champions =====
      function renderChampGrid() {
        container.innerHTML = "";
        if (!champions || champions.length === 0) {
          container.textContent = "Keine Champions geladen.";
          return;
        }

        champions.forEach((champKey) => {
          const img = document.createElement("img");
          img.src = `https://ddragon.leagueoflegends.com/cdn/${latestVersion}/img/champion/${champKey}.png`;
          img.alt = champKey;
          img.classList.add("champ");

          if (wonSet.has(champKey)) img.classList.add("won");

          img.addEventListener("click", () => {
            if (wonSet.has(champKey)) wonSet.delete(champKey);
            else wonSet.add(champKey);
            saveProfile();
            renderChampGrid();
          });

          container.appendChild(img);
        });
      }

      // ===== Profile Load / Save =====
      async function loadProfile(playerName) {
        if (unsubscribeSnapshot) {
          unsubscribeSnapshot();
          unsubscribeSnapshot = null;
        }
        setStatus("Lade Profil " + playerName + " …");
        wonSet.clear();
        renderChampGrid();

        if (useFirebase && db) {
          try {
            const { doc, onSnapshot } = await import(
              "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
            );
            const profileDocRef = doc(db, "profiles", playerName);
            unsubscribeSnapshot = onSnapshot(profileDocRef, (snap) => {
              wonSet =
                snap.exists() && Array.isArray(snap.data().won)
                  ? new Set(snap.data().won)
                  : new Set();
              renderChampGrid();
              setStatus("Profil geladen (Firebase)");
            });
            return;
          } catch (e) {
            console.warn("Firestore read error", e);
          }
        }

        const saved = localStorage.getItem("lol_won_" + playerName);
        if (saved) {
          try {
            wonSet = new Set(JSON.parse(saved));
          } catch (e) {
            wonSet = new Set();
          }
        }
        renderChampGrid();
        setStatus("Profil geladen (localStorage)");
      }

      function saveProfile() {
        if (debounceSaveTimer) clearTimeout(debounceSaveTimer);
        debounceSaveTimer = setTimeout(async () => {
          const arr = Array.from(wonSet);
          if (useFirebase && db) {
            try {
              const { doc, setDoc } = await import(
                "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
              );
              const profileDocRef = doc(db, "profiles", currentPlayer);
              await setDoc(profileDocRef, { won: arr }, { merge: true });
              setStatus("Profil gespeichert (Firebase)");
              return;
            } catch (e) {
              console.warn("Firestore write failed", e);
            }
          }
          localStorage.setItem("lol_won_" + currentPlayer, JSON.stringify(arr));
          setStatus("Profil gespeichert (localStorage)");
        }, 350);
      }

      // ===== Start =====
      await loadAllChamps();
      loadProfile(currentPlayer);
    </script>
  </body>
</html>

